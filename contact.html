<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact - Agorra</title>
  <style>
    body{
      font-family: Inter, system-ui, Arial;
      background: #080808;
      color: #fff;
      margin: 0;
      padding: 1rem;
    }
    .container{
      max-width: 900px;
      margin: 0 auto;
    }
    h1{
      font-family: Playfair Display, serif;
    }
    form{
      display: grid;
      gap: .6rem;
      margin-top: 1rem;
    }
    input, textarea{
      padding: .6rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .08);background: #0d0d0d; color: #fff;
    }
    button{
      padding: .6rem 1rem;
      border-radius: 8px;
      border: 0;
      background: #fff;
      color: #000;
      font-weight: 700;
    }
    .admin{
      margin-top: 1.2rem;
    }
    .msg{
      border-radius: 8px;
      padding: .8rem;
      margin-bottom: .6rem;
      background: linear-gradient(180deg, #0b0b0b, #0f0f0f);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="./index.html" style="color: #bbb;">IJ Back</a>
    <h1>Contact Agorra</h1>
    <p class="muted">Envoyez-nous un message. This demo stores messages locally in your browser using IndexedDB (client-side database).</p>
    <form id="ContactForm">
      <input id="name" placeholder="Your name">
      <input id="email" placeholder="Email" type="email" required>
      <input id="subject" placeholder="subject">
      <textarea id="message" rows="5" placeholder="Message" required></textarea>
      <div style="display: flex; gap: .6rem;">
        <button type="submit">Send</button>
        <button type="button" id="clearBtn">Clear Local DB</button>
      </div>
    </form>
    <section class="admin">
      <h2>Message sauvegarde(Local DB)</h2>
      <div id="messages"></div>
    </section>
  </div>
  <script>
    const DB_NAME = 'agorra_contact_db';
    const DB_VERSION = 1;
    let db;
    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e)=>{
          db = e.target.result;
          if(!db.objectStoreNames.contains('messages')){
            const store = db.createObjectStore('messages', {
              keypath: 'id', autoIncrement: true
            });
          }
        };
        req.onsuccess = e=>{
          db = e.target.result; resolve(db);};
          req.onerror = e=>reject(e.target.console.error);
      });
    }
    async function addMessage(obj){
      const d = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = d.transaction('messages', 'readwrite');
        const store = tx.objectStore('messages');
        const req = store.add(objectStore.assign({created: new Date().toISOString()}, obj));
        req.onsuccess = () => {resolve(true); loadMessages(); };
        req.onerror = e=>reject(e.target.error);
      });
    }
    async function loadMessages(){
      const d = await openDB();
      const tx = d.transaction('messages', readonly);
      const store = tx.objectStore('messages');
      const req = store.getAll();
      req.onsuccess = () =>{
        const out = document.getElementById('messages'); out.innerHTML='';
        req.result.reverse().forEach(m=>{
          const el = document.createElement('div'); el.className='msg';
          el.innerHTML=`<div style="font-weight: 700">${escapeHtml(n.name)} - <small class=\"muted\">${escapeHtml(m.email)}</samll></div>
                        <div styele=\"font-size: .9rem; margin: .3rem 0\">${escapeHtml(m.subject||'-')}</div>
                        <div>${escapeHtml(m.message)}</div>
                        <div style=\"font-size: .75rem; color: #999; margin-top: .4rem\">${new Date(m.created).toLocaleDateString()}</div>`;
          out.appendChild(el);
        });
      };
    }
    function clearDB(){
      const req = indexedDB.deleteDatabase(DB_NAME);
      req.onsuccess = ()=>{alert('Local DB cleared'); document.getElementById('messages').innerHTML='';};
    }
    function escapeHtml(str){if(!str) return''; return str.replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"})[c]||c);}
    document.getElementById('constantForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const data = {name: document.getElementById('name').value.trim(), email: document.getElementById('email').value.trim(), subject: document.getElementById('subject').value.trim(), message: document.getElementById('message').value.trim()};
      await addMessage(data);
      alert('Message saved Locally.');
      e.target.reset();
    });
    document.getElementById('clearBtn').addEventListener('click', ()=>{if(confirm('Clear local messages?')) clearDB(); });
    loadMessages().catch(()=>{});
  </script>
</body>
</html>